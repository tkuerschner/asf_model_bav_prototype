---
title: "experinentals"
author: "Tobias Kuerschner"
date: "2023-11-01"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
for (pckg in
  c
  (
    "tidyverse",
    "raster",
    "scico",
    "ggnewscale",
    "gganimate"
))
{
  if (!require(pckg, character.only = T)) {
    install.packages(pckg, dependencies = TRUE)
  }
  require(pckg, character.only = T)
}


setwd("D:/OneDrive/Projects/asf_bavaria/Prototype/asf_model_bav_prototype")

# pak::pak('thomasp85/gganimate')
```



```{r data prep}
it <- 82 #<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< SET ME
```


```{r raw data}
grid <- read.csv("./output/all_grid_states.csv", header = T)

globals <- read.csv("./output/all_global_variables.csv", header = T)

groups <- read.csv("./output/all_groups.csv", header = T)

dispersers <- read.csv("./output/all_dispersers.csv", header = T)

```



```{r data prep}
g1 <- grid # %>% filter(iteration == 1)

g2 <- g1 %>% mutate(quality = case_when(quality == -9999 ~ 0))

g2 <- g1 %>% mutate(quality = replace(quality, quality < 0, NA))

g3 <- g2 %>% filter(is_ap == "true")

g4 <- g2 %>% filter(is_territory == "true")

i1 <- groups %>% filter(iteration == 1)
```

```{r animate path of group}

disp_event <- dispersers

gr1 <- groups %>%
  group_by(iteration) %>%
  sample_n(1)

#gr1 <- groups %>% filter(group_id == 2) %>% group_by(iteration) #%>%
  #sample_n(1)

# head(gr1)

# gr1$target_cell

gr1 <- gr1 %>%
  mutate(target = gsub("\\[|\\]", "", target_cell)) %>%
  separate_rows(target, sep = ";") %>%
  separate(target, into = c("tx", "ty"), sep = "_", convert = TRUE)

gr2 <- gr1 %>%
  ungroup() %>%
  dplyr::select(iteration, x, y, movement_type, tx, ty, group_id)

buffer_size <- 20

mpz_data <- g2 %>%
  filter(
    x >= min(gr2$x) - buffer_size &
      x <= max(gr2$x) + buffer_size &
      y >= min(gr2$y) - buffer_size &
      y <= max(gr2$y) + buffer_size
  ) %>%
  dplyr::select(x, y, quality)

ap_data <- g3 %>%
 filter(
   x >= min(gr2$x) - buffer_size &
     x <= max(gr2$x) + buffer_size &
     y >= min(gr2$y) - buffer_size &
     y <= max(gr2$y) + buffer_size
 ) %>%
  dplyr::select(x, y,iteration)

terr_data <- g4 %>%
  filter(
    x >= min(gr2$x) - buffer_size &
      x <= max(gr2$x) + buffer_size &
      y >= min(gr2$y) - buffer_size &
      y <= max(gr2$y) + buffer_size
  ) %>%
  dplyr::select(x, y, quality,iteration, territory_of_group)

  #gr2 <- gr2 %>% filter(group_id == 1)
 #head(mpz_data)
 #head(ap_data)
 #head(terr_data)

gr2$group <- 1

grp_path_bp <- ggplot() +
  geom_tile(data = mpz_data, aes(x = x, y = y, fill = quality)) +
  scale_fill_gradient(low = "#c2e9cf", high = "#046104") +
  labs(fill = "Habitat quality") +
  new_scale_fill() +
  geom_tile(data = terr_data, aes(x = x, y = y, fill = quality), alpha = .5) +
  scale_fill_gradient(low = "#c2e9cf", high = "#c2653d") +
  #guides(fill = "none") +
  geom_path(data = gr2, aes(x = x, y = y, group = group_id), linewidth = 1, , color = "black", linetype = "dashed") +
  geom_point(data = gr2, aes(x, y, group = seq_along(iteration), color = movement_type), size = 1) +
  geom_point(data = gr2, aes(tx, ty, group = group_id), fill = "#c02ad3", colour = "#c02ad3", size = 2, shape = 8) +
  new_scale_fill() +
  geom_point(data = ap_data, aes(x = x, y = y), size = 2, color = "#003cff", fill = "blue", shape = 22) +
  new_scale_color() +
  geom_point(data = disp_event, aes(disperser_group_x, disperser_group_y, color = as.factor(disperser_id)),size = 1)+
  geom_path(data = disp_event, aes(disperser_group_x, disperser_group_y, color =  as.factor(disperser_id)),size = 1)+
  #labs(title = "Day: {frame_along}", color = "Movement") +
  theme_minimal() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 20)
  )



 #ggsave("example_movement5.png", grp_path_bp, width = 25, height = 25, units = "cm", dpi = 300)
animated_plot <- grp_path_bp +
  # transition_states(iteration, transition_length = 0.5, state_length = 0.5) +
  transition_reveal(iteration) +
  labs(fill = "Group movement", title = "Day: {frame_along}") +
  #transition_time(iteration) +
  enter_fade() +
  exit_fade()

# summary(mpz_data)
# summary(gr2)
anim_save(paste0("./R/asf_bavaria_analysis/visuals/example_movement_", it, ".gif"), animate(animated_plot)) # i get an eror here

```
```{r HRs}

#RColorBrewer::display.brewer.all()




grp_path_bp <- ggplot() +
  geom_tile(data = mpz_data, aes(x = x, y = y, fill = quality)) +
  scale_fill_gradient(low = "#c2e9cf", high = "#046104") +
  labs(fill = "Habitat quality") +
  new_scale_fill() +
  geom_tile(data = terr_data, aes(x = x, y = y, fill = as.factor(territory_of_group)), alpha = .5) +
  #scale_fill_brewer(palette = "Set3") +
  #cale_fill_gradient(low = "#c2e9cf", high = "#c2653d") +
  #guides(fill = "none") +
  #geom_path(data = gr2, aes(x = x, y = y, group = group_id), linewidth = 1, , color = "black", linetype = "dashed") +
  #geom_point(data = gr2, aes(x, y, group = seq_along(iteration), color = movement_type), size = 1) +
  geom_point(data = gr2, aes(tx, ty, group = group_id), fill = "#c02ad3", colour = "#c02ad3", size = 2, shape = 8) +
  new_scale_fill() +
  geom_point(data = ap_data, aes(x = x, y = y), size = 2, color = "#003cff", fill = "blue", shape = 22) +
  new_scale_color() +
  #geom_point(data = disp_event, aes(disperser_group_x, disperser_group_y, color = as.factor(disperser_id)),size = 1)+
  #geom_path(data = disp_event, aes(disperser_group_x, disperser_group_y, color =  as.factor(disperser_id)),size = 1)+
  #labs(title = "Day: {frame_along}", color = "Movement") +
  theme_minimal() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 20)
  )



ggsave(paste0("./R/asf_bavaria_analysis/visuals/example_hr_",it,".png"), grp_path_bp, width = 25, height = 25, units = "cm", dpi = 300)



```

```{r extract spatial memory}
## test case
# head(groups)

# testInd <- groups[333,]


grp1 <- groups %>%
  group_by(iteration) %>%
  sample_n(1)

# Create a new dataframe with multiple rows per iteration

detailed_path_df <- grp1 %>%
  group_by(iteration) %>%
  mutate(known_cells = gsub("\\[|\\]", "", known_cells)) %>%
  mutate(x = strsplit(as.character(known_cells), ";")) %>%
  unnest(x) %>%
  separate(x, into = c("x", "y"), sep = "_", convert = TRUE) %>%
  mutate(target = gsub("\\[|\\]", "", target_cell)) %>%
  separate_rows(target, sep = ";") %>%
  separate(target, into = c("tx", "ty"), sep = "_", convert = TRUE) %>%
  dplyr::select(-known_cells)

```

```{r space use}
# calculate space use from the x y coords in detailed_path_df

# Calculate space use
space_use <- detailed_path_df %>%
  count(x, y)

#space_use
```

```{r space use and path}

spuseplot <- ggplot() +
  geom_tile(data = mpz_data, aes(x = x, y = y, fill = quality)) +
  scale_fill_gradient(low = "#c2e9cf", high = "#046104") +
  labs(fill = "Habitat quality") +
  new_scale_fill() +
  geom_tile(data = terr_data, aes(x = x, y = y, fill = quality), alpha = .5) +
  scale_fill_gradient(low = "#c2e9cf", high = "#c2653d") +
  guides(fill = "none") +
  new_scale_fill() +
  geom_tile(data = space_use, aes(x = x, y = y, fill = log(n)), alpha = .5) +
  scale_fill_scico(palette = "berlin") +
  #labs(fill = "Space use", title = "Day: {current_frame}") #+
  theme_minimal() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 20)
  )

# geom_path(data = gr2, aes(x = x, y = y),  linewidth = .5, , color = "black", linetype = "dashed") +
# geom_point(data = gr2, aes(x, y, group = seq_along(iteration), color = movement_type), size = 1) +
# geom_point(data = gr2, aes(tx, ty), fill = "#c02ad3", colour = "#c02ad3", size = 3, shape = 8) +
# new_scale_fill() +
# geom_point(data = ap_data, aes(x = x, y = y), size = 1, color = "#003cff", fill = "blue", shape = 22) +
# labs(title = "Day: {frame_time}", fill = "Space use", color = "Attraction point")


animated_plot2 <- spuseplot +
  # transition_reveal(iteration)+
  transition_manual(iteration, cumulative = TRUE) +
   labs(fill = "Space use", title = "Day: {current_frame}") +
  # transition_states(iteration, transition_length = 0.5, state_length = 0.5) +
  # transition_time(iteration)+
  enter_fade() +
  exit_fade()

#animated_plot2 <- spuseplot +
#  transition_states(iteration, transition_length = 1, state_length = 1) +
#  #transition_reveal(iteration) +
#  enter_fade() +
#  exit_fade()


# summary(mpz_data)
# summary(gr2)
anim_save(paste0("./R/asf_bavaria_analysis/visuals/example_movement_", it, "_spaceUse.gif"), animate(animated_plot2))
```

```{r landscape, ap and groups}
(ggplot() +
  geom_tile(data = g2, aes(x = x, y = y, fill = quality)) +
  scale_fill_gradient(low = "#c2e9cf", high = "#046104") +
  new_scale_fill() +
  geom_tile(data = g4, aes(x = x, y = y, fill = quality), alpha = .5) +
  scale_fill_gradient(low = "#c2e9cf", high = "#c2653d") +
  geom_point(data = g3, aes(x = x, y = y), color = "#003cff") +
  geom_point(data = i1, aes(x = x, y = y, color = "red"), size = 1)# +
  #scale_x_reverse() +
  #coord_flip()
)


#g2 %>% filter(is_ap == "true")

```

```{r population metrics}


head(globals)

globals %>%
  ggplot(aes(iteration, n_individuals)) +
  geom_line() +
  labs(title = "Population size over time", x = "Day", y = "Population size") +
  theme_minimal()


head(groups)

g2 <- groups %>% dplyr::select(-known_cells, -target_cell)

head(g2)
max(g2$iteration)

gt <- g2 %>% filter(group_id == 1, iteration == 1) %>% summarise(n = n())


g3 <- g2 %>% group_by(group_id, iteration) %>%  summarise(n = n())


ggplot(g3)+
  geom_line(aes(iteration, n, color = as.factor(group_id)))

min(g3$n)

gt2 <- g2 %>% filter(iteration == 3650)

unique(gt2$group_id)
length(unique(gt2$group_id))

```

```{r dispersers}

head(dispersers)

uid <- unique(dispersers$disperser_id)

# one random entry of uid
random_disperser_id <- sample(uid, 1)

disp_event <- dispersers %>%
  filter(disperser_id == random_disperser_id) 

head(disp_event)
tail(disp_event)

ggplot()+
geom_tile(data = g2, aes(x = x, y = y, fill = quality)) +
  scale_fill_gradient(low = "#c2e9cf", high = "#046104") +
geom_point(data = disp_event, aes(x, y))

  #ggplot(aes(iteration, x, y)) +
  #geom_point() +
  #geom_path() +
  #labs(title = "Disperser movement", x = "Day", y = "Population size") +
  #theme_minimal()

```

```{r}

i1 <- groups %>% filter(individual_id == 41)

head(i1)

unique(i1$group_id)


unique(i1$iteration)



head(groups)

unique(groups$individual_id)


unique(dispersers$disperser_id)

```

```{r}
unique(gr1$group_id)

gr2 <- gr1 %>%
  ungroup() %>%
  dplyr::select(iteration, x, y, movement_type, tx, ty, group_id)



grp_path_bp <- ggplot() +
  geom_tile(data = mpz_data, aes(x = x, y = y, fill = quality)) +
  scale_fill_gradient(low = "#c2e9cf", high = "#046104") +
  labs(fill = "Habitat quality") +
  new_scale_fill() +
  geom_tile(data = terr_data, aes(x = x, y = y, fill = quality), alpha = .5) +
  scale_fill_gradient(low = "#c2e9cf", high = "#c2653d") +
  guides(fill = "none") +
  geom_path(data = gr2, aes(x = x, y = y, group = group_id), linewidth = 1, , color = "black", linetype = "dashed") +
  geom_point(data = gr2, aes(x, y, group = seq_along(iteration), color = movement_type), size = 2) +
  geom_point(data = gr2, aes(tx, ty), fill = "#c02ad3", colour = "#c02ad3", size = 4, shape = 8) +
  new_scale_fill() +
  geom_point(data = ap_data, aes(x = x, y = y), size = 2, color = "#003cff", fill = "blue", shape = 22) +
  labs(title = "Day: {frame_along}", color = "Movement") +
  theme_minimal() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 20)
  )





```

```{r animate memory}
ed1 <- new_df %>%
  # mutate(step = as.numeric(row.names(new_df)), x = (x-500)*-1 , y = (y-500)*-1)
  mutate(step = as.numeric(row.names(new_df)))

buffer_size <- 5

mpz_data <- g2 %>%
  filter(
    x >= min(ed1$x) - buffer_size &
      x <= max(ed1$x) + buffer_size &
      y >= min(ed1$y) - buffer_size &
      y <= max(ed1$y) + buffer_size
  )



# Create the base plot
# base_plot <- ggplot(data, aes(x, y)) +
#  geom_tile(color = "white", fill = "lightgrey", width = 1, height = 1) +
#  geom_point(size = 3, color = "blue") +
#  #xlim(min(data$x) - 1, max(data$x) + 1) +
#  #ylim(min(data$y) - 1, max(data$y) + 1) +
#  labs(title = "Step: {frame_time}")



bp <- ggplot() +
  geom_tile(data = mpz_data, aes(x = x, y = y, fill = quality)) +
  scale_fill_gradient(low = "#c2e9cf", high = "#046104") +
  geom_point(data = ed1, aes(x, y), size = 3, color = "blue") +
  geom_path(data = ed1, aes(x, y), color = "blue") +
  labs(title = "Step: {next_step}")

# draw_path_segments <- function(data) {
# segments <- data.frame(
#   x = c(data$x[-1], tail(data$x, 1)),
#   y = c(data$y[-1], tail(data$y, 1)),
#   xend = data$x,
#   yend = data$y
# )
# return(segments)
#

# animated_plot <- base_plot +
#  geom_segment(aes(xend = xend, yend = yend), data = draw_path_segments(data),
#               color = "darkblue", alpha = 0.5) +
#  transition_states(step, transition_length = 0.5, state_length = 0.5) +
#  enter_fade() +
#  exit_fade()

# Animate the plot
animated_plot <- bp +
  # geom_path(aes(group = 1), color = "darkblue", alpha = 0.5) +
  transition_states(step, transition_length = 0.5, state_length = 0.5) +
  enter_fade() +
  exit_fade()

# Save the animation
anim_save("example_movement.gif", animate(animated_plot))
```

```{r}
p <- ggplot(
  airquality,
  aes(Day, Temp, group = Month, color = factor(Month))
) +
  geom_line() +
  scale_color_viridis_d() +
  labs(x = "Day of Month", y = "Temperature") +
  theme(legend.position = "top")


p

p + transition_reveal(Day)
```

```{r}
grt <- gr2
grt %>% filter(iteration > 79)

grt1 <- grt %>% filter(iteration > 0, iteration < 99999999)


tt1 <- ggplot() +
  geom_tile(data = mpz_data, aes(x = x, y = y, fill = quality)) +
  scale_fill_gradient(low = "#c2e9cf", high = "#046104") +
  new_scale_fill() +
  geom_tile(data = terr_data, aes(x = x, y = y, fill = quality), alpha = .5) +
  scale_fill_gradient(low = "#c2e9cf", high = "#c2653d") +
  geom_path(data = grt1, aes(x = x, y = y), linewidth = 1, , color = "black", linetype = "dotted") +
  geom_point(data = grt1, aes(x, y, group = seq_along(iteration), color = movement_type), size = 3) +
  geom_point(data = ap_data, aes(x = x, y = y), size = 4, color = "#003cff") +
  geom_point(data = grt1, aes(tx, ty), fill = "#c02ad3", colour = "#c02ad3", size = 4, shape = 8) +
  # new_scale_fill()+
  # geom_tile(data = gr2, aes(x, y), fill = "#c74ec9")+
  # labs(title = "iteration: {frame_time}")
  labs(title = "Day: {frame_along}")

animated_plot <- tt1 +
  # transition_states(iteration, transition_length = 0.5, state_length = 0.5) +
  transition_reveal(iteration) +
  enter_fade() +
  exit_fade()

# summary(mpz_data)
# summary(gr2)
anim_save("example_movementTEST.gif", animate(animated_plot))
```


```{r animate dispersal} 
disp_event <- dispersers

gr1 <- groups %>%
  group_by(iteration) %>%
  sample_n(1)


# head(gr1)

# gr1$target_cell

gr1 <- gr1 %>%
  mutate(target = gsub("\\[|\\]", "", target_cell)) %>%
  separate_rows(target, sep = ";") %>%
  separate(target, into = c("tx", "ty"), sep = "_", convert = TRUE)

gr2 <- gr1 %>%
  ungroup() %>%
  dplyr::select(iteration, x, y, movement_type, tx, ty, group_id)

buffer_size <- 20

mpz_data <- g2 %>% 
  filter(
    x >= min(gr2$x) - buffer_size &
      x <= max(gr2$x) + buffer_size &
      y >= min(gr2$y) - buffer_size &
      y <= max(gr2$y) + buffer_size
  ) %>%
  dplyr::select(x, y, quality)

ap_data <- g3 %>%
  filter(
    x >= min(gr2$x) - buffer_size &
      x <= max(gr2$x) + buffer_size &
      y >= min(gr2$y) - buffer_size &
      y <= max(gr2$y) + buffer_size
  ) %>%
  dplyr::select(x, y)

terr_data <- g4 %>%
  filter(
    x >= min(gr2$x) - buffer_size &
      x <= max(gr2$x) + buffer_size &
      y >= min(gr2$y) - buffer_size &
      y <= max(gr2$y) + buffer_size
  ) %>%
  dplyr::select(x, y, quality)

  #gr2 <- gr2 %>% filter(group_id == 1)

gr2$group <- 1

grp_path_bp <- ggplot() +
  geom_tile(data = mpz_data, aes(x = x, y = y, fill = quality)) +
  scale_fill_gradient(low = "#c2e9cf", high = "#046104") +
  labs(fill = "Habitat quality") +
  new_scale_fill() +
  geom_tile(data = terr_data, aes(x = x, y = y, fill = quality), alpha = .5) +
  scale_fill_gradient(low = "#c2e9cf", high = "#c2653d") +
  # guides(fill = "none") +
  # geom_path(data = gr2, aes(x = x, y = y, group = group_id), linewidth = 1, , color = "black", linetype = "dashed") +
  # geom_point(data = gr2, aes(x, y, group = seq_along(iteration), color = movement_type), size = 2) +
  # geom_point(data = gr2, aes(tx, ty, group = group_id), fill = "#c02ad3", colour = "#c02ad3", size = 4, shape = 8) +
  new_scale_fill() +
  geom_point(data = ap_data, aes(x = x, y = y), size = 2, color = "#003cff", fill = "blue", shape = 22) +
  new_scale_color() +
  geom_point(data = disp_event, aes(x, y, color = as.factor(disperser_id))) +
  geom_path(data = disp_event, aes(x, y, color = as.factor(disperser_id))) +
  theme_minimal() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 20),
    legend.position = "none"
  )



# ggsave("example_movement.png", grp_path_bp, width = 10, height = 10, units = "cm", dpi = 300)
animated_plot3 <- grp_path_bp +
  # transition_states(iteration, transition_length = 0.5, state_length = 0.5) +
  transition_reveal(iteration) +
  labs(fill = "Dispersal movement", title = "Day: {frame_along}") +
  #transition_time(iteration) +
  enter_fade() +
  exit_fade()

# summary(mpz_data)
# summary(gr2)
anim_save(paste0("./R/asf_bavaria_analysis/visuals/example_movement_Dispersal_", it, ".gif"), animate(animated_plot3)) # i get an eror here

```

```{r}

x1 <- 57
y1 <- 151

x2 <- 164
y2 <- 203



dist <- (x1 - x2)^2 + (y1 - y2)^2 #<= 600 * 600

sqrt(dist)

```


```{r}

testGrid <- grid

test_x <- 160
test_y <- 280

# plot the grid with the test cell highlighted in red
ggp1 <- ggplot() +
  geom_tile(data = testGrid, aes(x = x, y = y, fill = quality)) +
  geom_tile(data = testGrid %>% filter(x == test_x, y == test_y), aes(x = x, y = y), fill = "red") +
  geom_point(data = testGrid %>% filter(x == test_x, y == test_y), aes(x = x, y = y), color = "red", size = 3) +
  scale_fill_gradient(low = "#c2e9cf", high = "#046104") +
  labs(fill = "Habitat quality") +
  theme_minimal()


 ggsave("testcell.png", ggp1, width = 25, height = 25, units = "cm", dpi = 300)


```


```{r}

# create a raster with 500 x 500 cells and a random value between 0.1 and 1.0 with resolution 50m x 50m
r <- raster(nrows = 500, ncols = 500, xmn = 0, xmx = 25000, ymn = 0, ymx = 25000, crs = "+proj=utm +zone=32 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0")

# fill the raster with values between 0.1 and 1.0
r[] <- runif(ncell(r), 0.1, 1.0)

#save the raster as ascii
writeRaster(r, "test.asc", format = "ascii")



```